# Story 1.2: MCP Server Core & Protocol Handler

**Status**: Ready for Development

## Story

**As a** Developer,
**I want** to implement the core MCP server with protocol message parsing and response formatting,
**so that** the server can receive and properly handle Model Context Protocol messages from AI agents.

## Acceptance Criteria

1. MCP server initialized using @modelcontextprotocol/sdk
2. Protocol handler component created to parse incoming MCP messages
3. Response formatter implemented for outgoing MCP messages
4. HTTP server (Express.js or Fastify) configured to serve MCP endpoints
5. Server-Sent Events (SSE) transport implemented for streaming responses
6. Request/response validation using Zod schemas
7. Error handling middleware for graceful error responses
8. Basic logging system in place for debugging protocol messages
9. Server can start on configurable port (default 3000)
10. Health check endpoint available at GET /health

## Tasks / Subtasks

- [ ] Set up MCP SDK integration
  - [ ] Install @modelcontextprotocol/sdk
  - [ ] Create MCP server instance
  - [ ] Review MCP specification implementation requirements
- [ ] Implement protocol handler
  - [ ] Create message parser for MCP messages
  - [ ] Implement message validation against MCP schema
  - [ ] Handle different message types (tool invocations, queries, etc.)
  - [ ] Create response formatter for MCP protocol
- [ ] Configure HTTP transport layer
  - [ ] Set up Express.js or Fastify server
  - [ ] Create HTTP endpoints for MCP protocol
  - [ ] Implement request routing
- [ ] Implement SSE transport
  - [ ] Create SSE endpoint for streaming responses
  - [ ] Handle SSE client connections and disconnections
  - [ ] Implement proper SSE event formatting
- [ ] Add validation and error handling
  - [ ] Create Zod schemas for request/response validation
  - [ ] Implement error handling middleware
  - [ ] Create error response formatting
  - [ ] Handle invalid protocol messages gracefully
- [ ] Set up logging
  - [ ] Configure logging library (Winston or Pino)
  - [ ] Add protocol message logging
  - [ ] Implement structured logging with correlation IDs
- [ ] Create health check endpoint
  - [ ] Implement GET /health endpoint
  - [ ] Return status and version information
- [ ] Write tests
  - [ ] Unit tests for protocol handler
  - [ ] Unit tests for message parsing and validation
  - [ ] Integration tests for HTTP endpoints (AC: #2-9)

## Dev Notes

### Architecture Reference
From `docs/architecture.md`:
- **MCP Server Core (3.1)**: Implement MCP protocol specification, handle tool registration and discovery, manage stateless HTTP + SSE communication, route requests to appropriate handlers
- **Key Components (3.1)**:
  - **Protocol Handler**: Manages MCP message parsing and response formatting
  - **Tool Registry**: Maintains catalog of available tools and their schemas
  - **Transport Layer**: Handles HTTP requests and Server-Sent Events (SSE)
- **Technology**: Node.js/TypeScript runtime, MCP SDK (@modelcontextprotocol/sdk), Express.js or similar
- **API Design (5.1)**: Reference MCP Tools Specification for message formats

### MCP Protocol Overview
The MCP (Model Context Protocol) is a standard for AI agent tool integration. The server must:
- Accept requests for tool discovery
- Parse tool invocation messages
- Execute tools and return results
- Stream long-running operations via SSE
- Handle errors gracefully and return proper error responses

### Implementation Notes
- Keep the server stateless - avoid storing state between requests where possible
- Use request correlation IDs for tracing across logs
- Implement proper cleanup for SSE connections
- Follow the MCP specification for all message formats: https://spec.modelcontextprotocol.io/

### Testing Standards

**Test File Location**: `tests/server/` or `src/server/**/*.test.ts`

**Testing Frameworks**: Jest or Vitest with TypeScript support

**Testing Requirements**:
- Unit tests for protocol handler functions
- Schema validation tests for request/response structures
- Integration tests for HTTP endpoints
- SSE connection handling tests
- Error handling tests for malformed messages
- At least 80% code coverage for protocol handler

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-15 | 1.0 | Initial story creation for Epic 1.2 | Bob (SM) |
