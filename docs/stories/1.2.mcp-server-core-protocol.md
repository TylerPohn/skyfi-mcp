# Story 1.2: MCP Server Core & Protocol Handler

**Status**: Ready for Review

**Agent Model Used**: claude-sonnet-4-5-20250929

## Story

**As a** Developer,
**I want** to implement the core MCP server with protocol message parsing and response formatting,
**so that** the server can receive and properly handle Model Context Protocol messages from AI agents.

## Acceptance Criteria

1. MCP server initialized using @modelcontextprotocol/sdk
2. Protocol handler component created to parse incoming MCP messages
3. Response formatter implemented for outgoing MCP messages
4. HTTP server (Express.js or Fastify) configured to serve MCP endpoints
5. Server-Sent Events (SSE) transport implemented for streaming responses
6. Request/response validation using Zod schemas
7. Error handling middleware for graceful error responses
8. Basic logging system in place for debugging protocol messages
9. Server can start on configurable port (default 3000)
10. Health check endpoint available at GET /health

## Tasks / Subtasks

- [x] Set up MCP SDK integration
  - [x] Install @modelcontextprotocol/sdk
  - [x] Create MCP server instance
  - [x] Review MCP specification implementation requirements
- [x] Implement protocol handler
  - [x] Create message parser for MCP messages
  - [x] Implement message validation against MCP schema
  - [x] Handle different message types (tool invocations, queries, etc.)
  - [x] Create response formatter for MCP protocol
- [x] Configure HTTP transport layer
  - [x] Set up Express.js or Fastify server
  - [x] Create HTTP endpoints for MCP protocol
  - [x] Implement request routing
- [x] Implement SSE transport
  - [x] Create SSE endpoint for streaming responses
  - [x] Handle SSE client connections and disconnections
  - [x] Implement proper SSE event formatting
- [x] Add validation and error handling
  - [x] Create Zod schemas for request/response validation
  - [x] Implement error handling middleware
  - [x] Create error response formatting
  - [x] Handle invalid protocol messages gracefully
- [x] Set up logging
  - [x] Configure logging library (Winston or Pino)
  - [x] Add protocol message logging
  - [x] Implement structured logging with correlation IDs
- [x] Create health check endpoint
  - [x] Implement GET /health endpoint
  - [x] Return status and version information
- [x] Write tests
  - [x] Unit tests for protocol handler
  - [x] Unit tests for message parsing and validation
  - [x] Integration tests for HTTP endpoints (AC: #2-9)

## Dev Notes

### Architecture Reference
From `docs/architecture.md`:
- **MCP Server Core (3.1)**: Implement MCP protocol specification, handle tool registration and discovery, manage stateless HTTP + SSE communication, route requests to appropriate handlers
- **Key Components (3.1)**:
  - **Protocol Handler**: Manages MCP message parsing and response formatting
  - **Tool Registry**: Maintains catalog of available tools and their schemas
  - **Transport Layer**: Handles HTTP requests and Server-Sent Events (SSE)
- **Technology**: Node.js/TypeScript runtime, MCP SDK (@modelcontextprotocol/sdk), Express.js or similar
- **API Design (5.1)**: Reference MCP Tools Specification for message formats

### MCP Protocol Overview
The MCP (Model Context Protocol) is a standard for AI agent tool integration. The server must:
- Accept requests for tool discovery
- Parse tool invocation messages
- Execute tools and return results
- Stream long-running operations via SSE
- Handle errors gracefully and return proper error responses

### Implementation Notes
- Keep the server stateless - avoid storing state between requests where possible
- Use request correlation IDs for tracing across logs
- Implement proper cleanup for SSE connections
- Follow the MCP specification for all message formats: https://spec.modelcontextprotocol.io/

### Testing Standards

**Test File Location**: `tests/server/` or `src/server/**/*.test.ts`

**Testing Frameworks**: Jest or Vitest with TypeScript support

**Testing Requirements**:
- Unit tests for protocol handler functions
- Schema validation tests for request/response structures
- Integration tests for HTTP endpoints
- SSE connection handling tests
- Error handling tests for malformed messages
- At least 80% code coverage for protocol handler

## Dev Agent Record

### Debug Log References
None

### Completion Notes
- **MCP Server Core**: Implemented full MCP protocol handler with HTTP/SSE transport
- **Protocol Handler**: Created comprehensive message parsing, validation, and response formatting using Zod schemas
- **HTTP Transport**: Set up Express.js server with endpoints for /health, /mcp, and /sse
- **SSE Transport**: Implemented Server-Sent Events for streaming with client connection management and cleanup
- **Error Handling**: Added graceful error handling with proper MCP error codes and middleware
- **Logging**: Integrated Winston logger from Story 1.1 with structured logging and request correlation IDs
- **Configuration**: Extended config to support PORT and HOST for server binding
- **Testing**: Created comprehensive unit tests for protocol handler (14 tests passing) and integration tests
- **Validation**: All acceptance criteria met and verified through manual testing with curl

### File List
**Source Files (Created/Modified)**:
- `src/index.ts` - Updated main entry point with HTTP server and graceful shutdown
- `src/server/config.ts` - Added PORT and HOST configuration
- `src/server/protocol.ts` - NEW: MCP protocol handler with message parsing and validation
- `src/server/transport.ts` - NEW: HTTP/SSE transport layer with Express.js
- `src/server/mcp-server.ts` - NEW: MCP server manager integrating protocol and transport
- `.env.example` - Added PORT and HOST configuration examples

**Test Files (Created)**:
- `tests/server/protocol.test.ts` - Protocol handler unit tests (14 tests)
- `tests/server/transport.test.ts` - HTTP/SSE transport integration tests
- `tests/server/mcp-server.test.ts` - MCP server manager tests
- `tests/integration/server.test.ts` - End-to-end server integration tests

**Configuration**:
- `jest.config.ts` - Updated with transformIgnorePatterns for ESM modules
- `package.json` - No changes (dependencies already installed)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-15 | 1.0 | Initial story creation for Epic 1.2 | Bob (SM) |
| 2025-11-15 | 1.1 | Story implementation complete - MCP Server Core & Protocol Handler | James (Dev Agent) |
