# Story 1.3: MCP Tool Registry & Transport Layer

**Status**: Ready for Development

## Story

**As a** Developer,
**I want** to implement the MCP Tool Registry system and complete the transport layer (HTTP + SSE),
**so that** tools can be registered, discovered by AI agents, and invoked through proper MCP communication channels.

## Acceptance Criteria

1. Tool Registry component created with capability to register MCP tools
2. Tool discovery endpoint implemented (GET /tools or equivalent MCP endpoint)
3. Tool schema validation using Zod for input parameters
4. HTTP request/response handling for tool invocations
5. SSE streaming support for long-running tool operations
6. Tool invocation routing to appropriate tool handlers
7. Request context passing (includes user session, headers, etc.)
8. Response marshalling for different tool return types (objects, arrays, streams)
9. Tool metadata and documentation retrievable via registry
10. Connection pooling and resource management for concurrent requests

## Tasks / Subtasks

- [ ] Implement Tool Registry
  - [ ] Create ToolRegistry class with registration methods
  - [ ] Add tool storage and lookup functionality
  - [ ] Implement schema validation for tool parameters
  - [ ] Create method to retrieve all registered tools
  - [ ] Support tool versioning and updates
- [ ] Create tool discovery endpoint
  - [ ] Implement tool listing endpoint
  - [ ] Return tool metadata (name, description, schema)
  - [ ] Filter tools by category if applicable
  - [ ] Format response according to MCP specification
- [ ] Implement tool invocation handling
  - [ ] Create request handler for tool calls
  - [ ] Validate input against tool schema
  - [ ] Route to appropriate tool implementation
  - [ ] Handle tool execution errors
  - [ ] Implement timeout handling
- [ ] Complete SSE implementation
  - [ ] Implement SSE response writer
  - [ ] Handle streaming responses from tools
  - [ ] Implement heartbeat/keep-alive messages
  - [ ] Proper cleanup on client disconnect
  - [ ] Support multiple concurrent SSE streams
- [ ] Add request context management
  - [ ] Create RequestContext type with session, user, headers
  - [ ] Implement context extraction from HTTP requests
  - [ ] Pass context through tool invocation chain
  - [ ] Support context-based tool filtering
- [ ] Response marshalling
  - [ ] Handle object responses
  - [ ] Handle array responses
  - [ ] Handle streaming responses
  - [ ] Handle null/undefined responses
  - [ ] Implement response serialization
- [ ] Write tests
  - [ ] Unit tests for Tool Registry operations
  - [ ] Integration tests for tool discovery endpoint (AC: #2)
  - [ ] Integration tests for tool invocation (AC: #4, #6)
  - [ ] SSE streaming tests (AC: #5)
  - [ ] Error handling tests (AC: #6)
  - [ ] Concurrency tests for multiple simultaneous requests

## Dev Notes

### Architecture Reference
From `docs/architecture.md`:
- **Tool Registry (3.1)**: Maintains catalog of available tools and their schemas
- **Transport Layer (3.1)**: Handles HTTP requests and Server-Sent Events (SSE)
- **Tool Handlers (3.2)**: Each tool implements a specific capability with defined inputs/outputs
- **Tools Specification (5.1)**: Reference schemas for search_geospatial_data, check_order_feasibility, place_order, setup_monitoring, get_previous_orders

### Tool Registry Design
The tool registry is a central component that:
- Stores metadata about all available tools
- Validates tool parameters against their schemas
- Routes tool invocation requests to handlers
- Provides discovery for AI agents

### Tool Examples (to be implemented in future stories)
1. `search_geospatial_data` - Search datasets by location
2. `check_order_feasibility` - Validate order feasibility
3. `place_order` - Submit geospatial data orders
4. `setup_monitoring` - Configure AOI monitoring
5. `get_previous_orders` - Retrieve order history

For this story, create the infrastructure; actual tools are implemented in subsequent stories.

### Testing Standards

**Test File Location**: `tests/server/registry/` or `src/server/**/*.test.ts`

**Testing Frameworks**: Jest or Vitest

**Testing Requirements**:
- Unit tests for Registry registration, lookup, and retrieval
- Schema validation tests for different parameter types
- Integration tests for tool discovery endpoint
- Integration tests for tool invocation flow
- Concurrency tests for multiple simultaneous tool invocations
- SSE connection lifecycle tests
- Memory/resource leak tests for long-running streams
- At least 80% code coverage for registry

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-15 | 1.0 | Initial story creation for Epic 1.3 | Bob (SM) |
