# Story 1.4: Authentication & API Key Management

**Status**: Ready for Development

## Story

**As a** Developer,
**I want** to implement secure API key management and authentication mechanisms,
**so that** the MCP server can securely authenticate requests and manage user credentials for SkyFi API access.

## Acceptance Criteria

1. API key validation middleware implemented
2. Environment variable loading and validation (using .env files)
3. Secure credential storage configuration (P0: local, P1: cloud secrets manager)
4. Authentication context creation from API keys
5. Request authentication middleware that validates API keys
6. API key rotation support
7. Rate limiting per API key
8. Secure credential retrieval without exposing secrets in logs
9. Configuration validation on server startup
10. Support for multiple authentication methods (API key, OAuth token ready for P1)

## Tasks / Subtasks

- [ ] Create authentication utilities
  - [ ] Implement API key validation function
  - [ ] Create authentication context type
  - [ ] Implement middleware for request authentication
  - [ ] Add audit logging for authentication events
- [ ] Implement credential management
  - [ ] Create credential store interface
  - [ ] Implement local file-based credential store (P0)
  - [ ] Add credential encryption/decryption
  - [ ] Create credential loading from environment
  - [ ] Support .env file parsing
- [ ] Set up environment configuration
  - [ ] Create config loader module
  - [ ] Implement config validation with Zod
  - [ ] Define required environment variables
  - [ ] Create .env.example template
  - [ ] Add startup validation
- [ ] Implement rate limiting
  - [ ] Create rate limiter middleware
  - [ ] Implement per-API-key rate limiting
  - [ ] Set configurable rate limit thresholds
  - [ ] Return proper rate limit headers
  - [ ] Log rate limit violations
- [ ] Add API key rotation support
  - [ ] Design API key format and versioning
  - [ ] Implement key rotation mechanism
  - [ ] Support multiple keys per user (old and new)
  - [ ] Grace period for old keys
- [ ] Security hardening
  - [ ] Implement TLS/SSL configuration
  - [ ] Add CORS configuration
  - [ ] Implement request signing/verification
  - [ ] Sanitize logs to prevent credential leakage
  - [ ] Add security headers middleware
- [ ] Create configuration files
  - [ ] Create .env.example with all required variables
  - [ ] Document all configuration options
  - [ ] Add comments for sensitive settings
- [ ] Write tests
  - [ ] Unit tests for API key validation
  - [ ] Unit tests for credential encryption/decryption
  - [ ] Integration tests for authentication middleware
  - [ ] Rate limiting tests (AC: #7)
  - [ ] Config validation tests
  - [ ] Security tests for credential exposure
  - [ ] At least 85% code coverage for auth module

## Dev Notes

### Architecture Reference
From `docs/architecture.md`:
- **Authentication Flow (3.3)**:
  1. User provides API credentials (API key or OAuth token)
  2. Credentials stored securely:
     - P0: Local environment variables or config file
     - P1: Cloud-based credential management (AWS Secrets Manager, etc.)
  3. MCP server includes credentials in SkyFi API requests
  4. Multi-user support (P1): Separate credential management per user
- **Security Measures (3.3)**:
  - TLS/SSL for all communications
  - API key rotation support
  - Rate limiting per user/session
  - Secure credential storage (encrypted at rest)

### Key Implementation Details
For P0 (this story), focus on:
- Local .env file-based credential storage
- Environment variable loading
- Basic encryption for stored credentials
- Per-API-key rate limiting
- OAuth token structure (not implementation, just structure for P1)

For P1 (future story):
- AWS Secrets Manager integration
- Multi-user isolation
- Advanced credential management
- OAuth 2.0 implementation

### Configuration Template
```
# .env.example
SKYFI_API_KEY=your_api_key_here
SERVER_PORT=3000
NODE_ENV=development
TLS_ENABLED=false
RATE_LIMIT_REQUESTS=100
RATE_LIMIT_WINDOW_MS=60000
LOG_LEVEL=info
```

### Testing Standards

**Test File Location**: `tests/auth/` or `src/auth/**/*.test.ts`

**Testing Frameworks**: Jest or Vitest

**Testing Requirements**:
- API key validation tests (valid, invalid, expired keys)
- Authentication middleware tests
- Rate limiting tests with various request patterns
- Config validation tests for different scenarios
- Credential encryption/decryption tests
- Security tests ensuring no credential leakage in logs
- Integration tests for authentication flow
- At least 85% code coverage for auth modules

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-15 | 1.0 | Initial story creation for Epic 1.4 | Bob (SM) |
